<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Carrito</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #ffc9d9;
      font-family: 'Segoe UI', sans-serif;
      color: #001f3f;
    }
    .contenedor {
      max-width: 1000px;
      margin: 60px auto;
      background: white;
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      text-align: center;
    }
    .titulo {
      font-size: 28px;
      margin-bottom: 20px;
    }
    .productos-carrito {
      display: flex;
      flex-direction: column;
      gap: 20px;
      text-align: left;
    }
    .carrito-item {
      display: flex;
      gap: 20px;
      align-items: center;
      border-bottom: 1px solid #ddd;
      padding-bottom: 20px;
    }
    .carrito-item img {
      width: 120px;
      border-radius: 8px;
    }
    .item-info h3 {
      margin: 0 0 8px;
      font-size: 20px;
    }
    .item-info p {
      margin: 4px 0;
      font-size: 16px;
    }
    .item-info .cantidad-control {
      margin-top: 8px;
    }
    .item-info .cantidad-control input {
      width: 60px;
      padding: 4px;
      font-size: 16px;
    }
    .item-info .subtotal-item {
      margin-top: 8px;
      font-weight: bold;
    }
    .resumen {
      margin-top: 30px;
      text-align: right;
      font-size: 18px;
    }
    .resumen p {
      margin: 8px 0;
    }
    .botones-final {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }
    .botones-final button {
      background-color: #001f3f;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      transition: all 0.2s ease;
    }
    .botones-final button#btn-pagar {
      background-color: #25D366;
    }
    .botones-final button:hover {
      transform: translateY(-2px);
    }
    .botones-final button#btn-atras:hover {
      background-color: #555;
    }
    .botones-final button#btn-seguir:hover {
      background-color: #003366;
    }
    .texto-vacio, .botones-vacios button {
      margin-top: 20px;
    }
    .botones-vacios button {
      margin: 0 10px;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      background: #001f3f;
      color: white;
      cursor: pointer;
      transition: background 0.2s;
    }
    .botones-vacios button:hover {
      background: #003366;
    }
  </style>
</head>
<body>
  <div id="contenido">
    <div class="contenedor">
      <div class="titulo">Tu carrito está vacío</div>
      <div class="texto-vacio">No has agregado ningún producto todavía.</div>
      <div class="botones-vacios">
        <button onclick="history.back()">Atrás</button>
        <button onclick="location.href='index.html'">Inicio</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const key = "carrito";
      const stored = JSON.parse(localStorage.getItem(key) || "[]");
      const cont = document.getElementById("contenido");
      if (stored.length === 0) return;

      // Array local con cantidades y su índice original
      const cart = stored.map((prod, idx) => ({
        ...prod,
        cantidad: 1,
        index: idx
      }));

      // Renderiza todo el carrito
      function renderCart() {
        let html = `
          <div class="contenedor">
            <div class="titulo">Tu carrito (${cart.length})</div>
            <div class="productos-carrito">
              ${cart.map(item => {
                const precioUnit = item.precio;
                const precioDesc = item.descuento > 0
                  ? precioUnit * (1 - item.descuento/100)
                  : precioUnit;
                const subtotal = (precioDesc * item.cantidad).toFixed(2);
                return `
                  <div class="carrito-item" data-idx="${item.index}">
                    <img src="${item.fotos[0]}" alt="${item.nombre}">
                    <div class="item-info">
                      <h3>${item.nombre}</h3>
                      <p><strong>Precio unitario:</strong>
                        $${precioUnit.toFixed(2)}
                        ${item.descuento > 0
                          ? `(–${item.descuento}% → $${precioDesc.toFixed(2)})`
                          : ``}
                      </p>
                      ${item.tallaSeleccionada
                        ? `<p><strong>Talla:</strong> ${item.tallaSeleccionada}</p>`
                        : ``}
                      ${item.marcas?.length
                        ? `<p><strong>Marca:</strong> ${item.marcas.join(", ")}</p>`
                        : ``}
                      <div class="cantidad-control">
                        <label>Cantidad:
                          <input type="number" min="1" value="${item.cantidad}"
                                 data-idx="${item.index}" class="cantidad-input">
                        </label>
                      </div>
                      <p class="subtotal-item">Subtotal: $${subtotal}</p>
                    </div>
                  </div>
                `;
              }).join("")}
            </div>

            <div class="resumen">
              <p>Total sin descuento: $${ totalSinDescuento().toFixed(2) }</p>
              <p>Total con descuento: $${ totalConDescuento().toFixed(2) }</p>
            </div>

            <div class="botones-final">
              <button id="btn-atras">Atrás</button>
              <button id="btn-pagar">Pagar por WhatsApp</button>
              <button id="btn-seguir">Seguir comprando</button>
            </div>
          </div>
        `;
        cont.innerHTML = html;

        // Cambios en cantidad
        document.querySelectorAll(".cantidad-input").forEach(input => {
          input.addEventListener("change", e => {
            const idx = +e.target.dataset.idx;
            const val = Math.max(1, +e.target.value);
            cart.find(it => it.index === idx).cantidad = val;
            renderCart();
          });
        });

        // Botón ATRÁS
        document.getElementById("btn-atras")
          .addEventListener("click", () => history.back());

        // Botón PAGAR
        document.getElementById("btn-pagar")
          .addEventListener("click", () => {
            const lines = cart.map(item => {
              const pd = item.descuento > 0
                ? (item.precio*(1-item.descuento/100)).toFixed(2)
                : item.precio.toFixed(2);
              let line = `- ${item.nombre} ×${item.cantidad} @ $${pd}`;
              if (item.tallaSeleccionada) line += ` (Talla: ${item.tallaSeleccionada})`;
              if (item.marcas?.length)      line += ` (Marca: ${item.marcas.join(", ")})`;
              return line;
            }).join("%0A");

            const mensaje =
              `Hola!%0AQuisiera hacer el pedido:%0A${lines}` +
              `%0A%0ATotal sin descuento: $${totalSinDescuento().toFixed(2)}` +
              `%0ATotal con descuento: $${totalConDescuento().toFixed(2)}` +
              `%0A%0AMuchas gracias!`;

            const waLink = `https://wa.me/TU_NUMERO_WHATSAPP?text=${mensaje}`;
            window.open(waLink, "_blank");
          });

        // Botón SEGUIR COMPRANDO
        document.getElementById("btn-seguir")
          .addEventListener("click", () => location.href = 'index.html');
      }

      // Cálculo de totales
      function totalSinDescuento() {
        return cart.reduce((sum, item) =>
          sum + item.precio * item.cantidad, 0
        );
      }
      function totalConDescuento() {
        return cart.reduce((sum, item) => {
          const pu = item.descuento > 0
            ? item.precio*(1-item.descuento/100)
            : item.precio;
          return sum + pu*item.cantidad;
        }, 0);
      }

      renderCart();
    });
  </script>
</body>
</html>
